name: Release XRPC

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    name: Build and publish XRPC
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tag commit is on master
        id: onmaster
        run: |
          git fetch origin master --depth=1
          if git merge-base --is-ancestor "${GITHUB_SHA}" origin/master; then
            echo "ok=true" >> $GITHUB_OUTPUT
            echo "Tag commit is on master"
          else
            echo "ok=false" >> $GITHUB_OUTPUT
            echo "Tag commit is NOT on master. Skipping build." >&2
          fi

      - name: Setup Go
        if: steps.onmaster.outputs.ok == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.25.x'
          cache: true

      - name: Setup Node (for UI build)
        if: steps.onmaster.outputs.ok == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: |
            xrpc/web/pnpm-lock.yaml

      - name: Enable corepack + pnpm
        if: steps.onmaster.outputs.ok == 'true'
        run: |
          set -euxo pipefail
          corepack enable
          corepack prepare pnpm@8 --activate

      - name: Build XRPC Web UI
        if: steps.onmaster.outputs.ok == 'true'
        run: |
          set -euxo pipefail
          cd xrpc/web
          pnpm install --frozen-lockfile
          pnpm build

      - name: Build XRPC binary (-tags ui_embed)
        if: steps.onmaster.outputs.ok == 'true'
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: '0'
        run: |
          set -euxo pipefail
          mkdir -p build artifacts
          EXT=""
          if [ "$GOOS" = "windows" ]; then EXT=".exe"; fi
          go build -tags ui_embed -trimpath -ldflags "-s -w" -o "build/xrpc${EXT}" ./xrpc
          ARTIFACT="xrpc_${GITHUB_REF_NAME}_${GOOS}_${GOARCH}"
          if [ "$GOOS" = "windows" ]; then
            (cd build && zip -9 "../artifacts/${ARTIFACT}.zip" "xrpc${EXT}")
            (cd artifacts && sha256sum "${ARTIFACT}.zip" > "${ARTIFACT}.zip.sha256")
          else
            tar -C build -czf "artifacts/${ARTIFACT}.tar.gz" "xrpc${EXT}"
            (cd artifacts && sha256sum "${ARTIFACT}.tar.gz" > "${ARTIFACT}.tar.gz.sha256")
          fi

      - name: Publish GitHub Release assets
        if: steps.onmaster.outputs.ok == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
